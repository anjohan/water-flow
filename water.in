include system.in
log data/log.water

variable dt equal ${dt_withwater}
variable total_time equal 1000
variable num_steps equal ${total_time}/${dt}

variable dumpperiod equal 10000
variable longdumpperiod equal ${dumpperiod}*10
variable dx equal ${x}/30
variable Vperchunk equal ${dx}*${dx}*${dx}
print ${Vperchunk} file "data/Vperchunk.dat"

#/atom 1 silicon
#/atom 2 oxygen
#/atom 3 hydrogen
#/bond 1 2 2.6
#/bond 2 3 1.4

units metal
boundary p p p
atom_style atomic

read_data data/withwater.data

pair_style  usc
pair_coeff  * * SiOH2O.vashishta Si O H
pair_modify coord 2 1 2.0 0.3
pair_modify coord 2 3 1.4 0.3
mass            1 28.08
mass            2 15.9994
mass            3 1.00794

include common_regions_groups.in
group moving subtract all rigidslab

group water subtract moving slab cylinder
group movingsilicate subtract moving water

timestep ${dt}
minimize 1e-6 1e-6 1000 1000
write_data data/01_withwater_minimised.data

compute potperatom all pe/atom
compute binning all chunk/atom bin/3d x lower ${dx} y lower ${dx} z lower ${dx}

compute stress_x_V_per_atom all stress/atom NULL ke pair
# variable pressure_per_chunk atom '-(c_stress_x_V_per_atom[1]+c_stress_x_V_per_atom[2]+c_stress_x_V_per_atom[3])/(3*(${Vperchunk}))'

fix temp_per_chunk all ave/chunk 100 100 10000 binning temp file data/temp_per_chunk.profile
fix pressure_per_chunk all ave/chunk 100 100 10000 binning c_stress_x_V_per_atom[1] c_stress_x_V_per_atom[2] c_stress_x_V_per_atom[3] norm sample file data/stress_x_V_per_chunk.profile

fix waterintegrator water nve
fix thermostat movingsilicate nvt temp $T $T 1.0
velocity moving create ${T} 277385 mom yes loop geom

fix externalforce water addforce 0.0001 0 0
variable vcmx_water equal vcm(water,x)
compute watertemp water temp

compute vacf water vacf
thermo 100
thermo_style custom step time temp c_watertemp v_vcmx_water ke pe etotal press pzz c_vacf[4] spcpu cpuremain
dump dump all custom ${dumpperiod} data/water.in.bin id type x y z xu yu zu c_potperatom
dump raredump all custom ${longdumpperiod} data/waterlowfrequency.in.bin id type x y z xu yu zu c_potperatom

restart 100000 data/water.*.restart


run ${num_steps}

write_data data/withwater_${total_time}ps.data

