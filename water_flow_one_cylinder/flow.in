include system.in
log data/log.water_${FORCE}_${ITERATION}

read_restart data/restart.flow_${FORCE}_$(v_ITERATION-1)

if "${ITERATION} == 1" then "reset_timestep 0"

#/atom 1 silicon
#/atom 2 oxygen
#/atom 3 hydrogen
#/bond 1 2 2.6
#/bond 2 3 1.4

pair_style  usc
pair_coeff  * * SiOH2O.vashishta Si O H
pair_modify coord 2 1 2.0 0.3
pair_modify coord 2 3 1.4 0.3
mass            1 28.08
mass            2 15.9994
mass            3 1.00794

include common_regions_groups.in

variable total_time equal 200
variable dt equal ${dt_withwater}
variable num_steps equal ${total_time}/${dt}

variable dumpperiod equal 50000
variable longdumpperiod equal ${dumpperiod}*10
variable dx_temppress equal ${x}/30
variable Vperchunk equal ${dx_temppress}*${dx_temppress}*${dx_temppress}
print ${Vperchunk} file "data/Vperchunk.dat"

timestep ${dt}

compute potperatom all pe/atom
compute binning_temppress all chunk/atom bin/3d x lower ${dx_temppress} y lower ${dx_temppress} z lower ${dx_temppress}

compute stress_x_V_per_atom all stress/atom NULL ke pair
# variable pressure_per_chunk atom '-(c_stress_x_V_per_atom[1]+c_stress_x_V_per_atom[2]+c_stress_x_V_per_atom[3])/(3*(${Vperchunk}))'

fix temp_per_chunk all ave/chunk 200 500 100000 binning_temppress temp file data/temp_per_chunk_${FORCE}.profile
fix pressure_per_chunk all ave/chunk 200 500 100000 binning_temppress c_stress_x_V_per_atom[1] c_stress_x_V_per_atom[2] c_stress_x_V_per_atom[3] norm sample file data/stress_x_V_per_chunk_${FORCE}_${ITERATION}.profile

fix waterintegrator water nve
fix thermostat movingsilicate nvt temp $T $T 1.0
velocity moving create ${T} 277385 mom yes loop geom

fix externalforce water addforce ${FORCE} 0 0
variable vcmx_water equal vcm(water,x)
compute watertemp water temp

group oxygen type 2
group water_oxygen intersect water oxygen

compute vacf water vacf
thermo 100
thermo_style custom step time temp c_watertemp v_vcmx_water ke pe etotal press pzz c_vacf[4] spcpu cpuremain
dump dump all custom ${dumpperiod} data/water_${FORCE}_${ITERATION}.bin id type x y z vx vy vz fx fy fz xu yu zu c_potperatom
dump raredump all custom ${longdumpperiod} data/waterlowfrequency_${FORCE}_${ITERATION}.bin id type x y z vx vy vz fx fy fz xu yu zu c_potperatom

# ===== binning for vx ===== #
variable num_bins_xy equal 400
variable num_bins_z  equal 50
fix velave water_oxygen velocityaverage data/v_${FORCE}_${ITERATION}.bin 20 100000 ${num_bins_xy} ${num_bins_xy} ${num_bins_z} 0 $(lx) 0 $(ly) ${z_topofslab} ${z_topofcylinder}

run ${num_steps}
write_restart data/restart.flow_${FORCE}_${ITERATION}
